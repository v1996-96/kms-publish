#!/bin/bash
set -e

psql -v ON_ERROR_STOP=1 -v DOCKER_USER=$DOCKER_USER -v DOCKER_PASSWORD="'$DOCKER_PASSWORD'" --username "$POSTGRES_USER" <<-EOSQL
    CREATE USER :DOCKER_USER WITH PASSWORD :DOCKER_PASSWORD;
    CREATE DATABASE kms;
    GRANT ALL PRIVILEGES ON DATABASE kms TO :DOCKER_USER;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO :DOCKER_USER;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO :DOCKER_USER;
EOSQL

psql --username "$POSTGRES_USER" "kms" < "/app/dump.sql"
